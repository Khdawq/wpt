<title>
  Tests the redirect interaction with COOP same-origin-allow-popups.
</title>
<meta name=timeout content=long>
<script src=/resources/testharness.js></script>
<script src=/resources/testharnessreport.js></script>
<script src=/common/get-host-info.sub.js></script>
<script src="/common/utils.js"></script>
<script src="/common/dispatcher/dispatcher.js"></script>
<script src="/html/cross-origin-opener-policy/resources/common.js"></script>
<script src="/html/cross-origin-opener-policy/reporting/resources/reporting-common.js"></script>
<script>

  const same_origin = {
    host: get_host_info().HTTPS_ORIGIN,
    name: "Same origin"
  };
  const cross_origin = {
    host: get_host_info().HTTPS_REMOTE_ORIGIN,
    name: "Cross origin"
  };

  function reportToken() {
    // Report endpoint name must start with lower case alphabet.
    return token().replace(/./, 'a');
  }

  // Tests the redirect interaction with COOP same-origin-allow-popups and
  // reporting:
  // 1 - open the opener document on origin same_origin wit COOP
  // unsafe-none.
  // 2 - opener opens popup with document on origin popup_origin, with COOP
  // same_origin, Reporting-Endpoints header and a redirect header
  // (HTTP 302, location).
  // 3 - redirection to a document with origin same_origin and COOP
  // unsafe-none.
  //
  // Navigation 2) should generate a report sent to B's reporter(navigation-to).
  // Navigation 3) should generate a report sent to B's reporter(navigation-from).
  //
  // A opens B, B redirects to C.
  //
  // Document  Origin        COOP
  // --------  ------------  ------------------------
  // A         same-origin   unsafe-none
  // B         popup-origin  same-origin
  // C         same-origin   unsafe-none
function redirect_test(popup_origin) {
  promise_test(async t => {
    // The test window.
    const this_window_token = token();

    // The "opener" window. This has COOP unsafe-none and no reporter.
    const opener_token = token();
    const opener_url = same_origin.host + executor_path +
      `&uuid=${opener_token}`;

    // The "openee" window.
    // The initial document have COOP, reporter and is on popup_origin, it
    // redirects to a same-origin (with the opener) document with no COOP.
    const openee_token = token();
    const openee_report_token = reportToken();
    const openee_reporting = reportingEndpointsHeaders(openee_report_token);
    const openee_redirect_url = same_origin.host + executor_path +
      `&uuid=${openee_token}`;
    const redirect_header = '|status(302)' +
      `|header(Location,${encodeURIComponent(
        openee_redirect_url)})`;
    const openee_url = (popup_origin.host + executor_path
      + openee_reporting.header + openee_reporting.coopSameOriginHeader
      + redirect_header + `&uuid=${openee_token}`)
      .replace(/,/g, "\\,")
      .replace(/\\\\,/g, "\\\\\\,")
      .replace(/\(/g, "%28")
      .replace(/\)/g, "%29");
    // 1. Create the opener window.
    let opener_window_proxy = window.open(opener_url);
    t.add_cleanup(() => send(opener_token, "window.close()"));

    // 2. The opener opens its openee.
    send(opener_token, `
      openee = window.open(\`${openee_url}\`);
    `);
    t.add_cleanup(() => send(openee_token, "window.close()"));

    // 3. Check the opener status on the openee.
    send(openee_token, `
      send("${this_window_token}", opener !== null);
    `);
    assert_equals(await receive(this_window_token), "false", "opener");

    // 4. Check the openee status on the opener.
    send(opener_token, `
      send("${this_window_token}", openee.closed);
    `);
    assert_equals(await receive(this_window_token), "true", "openee.closed");

    // 5. Check a report sent to the openee.
    let report = await receiveReport(
      openee_report_token,
      "navigation-to-response");
    assert_equals(report.type, "coop");
    assert_equals(report.body.disposition, "enforce");
    assert_equals(report.body.effectivePolicy, "same-origin");
    // 6. Check a report sent to the opener.
    report = await receiveReport(
      openee_report_token,
      "navigation-from-response");
    assert_equals(report.type, "coop");
    assert_equals(report.body.disposition, "enforce");
    assert_equals(report.body.effectivePolicy, "same-origin");
  }, `${popup_origin.name} openee redirected to same-origin with same-origin-allow-popups`);
}

redirect_test(same_origin);
redirect_test(cross_origin);
</script>
